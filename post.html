<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Detalles de la publicación</title>
  <link rel="stylesheet" href="css/post.css">
</head>
<body>
  <header>
    <div class="container">
      <div class="header-content">
        <a href="index1.html">
          <img class="logo" src="storage/img/Diseño Proyecto Progresivo Pag 1-05.png">
        </a>
      </div>
    </div>
  </header>

    <div class="container">
    <div id="post"></div>

    <h3>Comentarios</h3>
    <div class="order-container">
      <label for="orderSelect"><strong>Ordenar por:</strong></label>
      <select id="orderSelect">
        <option value="desc">Más recientes</option>
        <option value="asc">Más antiguos</option>
      </select>
    </div>
    <div id="comments"></div>

    <div class="comment-form">
      <textarea id="new-comment" placeholder="Escribe un comentario..."></textarea>
      <button onclick="addComment()">Comentar</button>
      <a href="index.html" class="back-link">Volver al foro</a>
    </div>

  </div>

  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyCL2CctB5ULQg2tkWKKTX20-Aot0aGsVYw",
      authDomain: "registrocon-97cb2.firebaseapp.com",
      projectId: "registrocon-97cb2",
      storageBucket: "registrocon-97cb2.appspot.com",
      messagingSenderId: "373644979789",
      appId: "1:373644979789:web:5b08ef46eb8852c59fb604"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    const postId = new URLSearchParams(location.search).get("id");
    let unsubscribeComments = null;
    
    // Referencias DOM
    const postElement = document.getElementById("post");
    const commentsElement = document.getElementById("comments");
    const orderSelect = document.getElementById("orderSelect");
    const commenterName = document.getElementById("commenterName");
    const commentText = document.getElementById("commentText");
    const btnAddComment = document.getElementById("btnAddComment");
    const commentError = document.getElementById("commentError");
    const commentSuccess = document.getElementById("commentSuccess");

    // Cargar post
    function loadPost(id) {
      if (!id) {
        postElement.innerHTML = '<p class="error-message">No se encontró la publicación</p>';
        return;
      }

      db.collection("posts").doc(id).get().then(doc => {
        if (!doc.exists) {
          postElement.innerHTML = '<p class="error-message">La publicación no existe o fue eliminada</p>';
          return;
        }
        
        const p = doc.data();
        document.title = `${p.title || 'Publicación'} - Detalles`;
        
        postElement.innerHTML = `
          <div class="post-header">
            <img src="${p.authorPhotoURL || '/placeholder.svg?height=60&width=60'}" alt="Foto autor" class="post-author-photo">
            <div>
              <strong class="post-author-name">${p.authorName || 'Usuario anónimo'}</strong><br>
              <small class="post-date">${p.createdAt?.toDate().toLocaleString() || ''}</small>
            </div>
          </div>
          ${p.topicName ? `<span class="post-topic">${p.topicName}</span>` : ''}
          <h2 class="post-title">${p.title || ''}</h2>
          <div class="post-content-full">${p.content || ''}</div>
        `;
      }).catch(error => {
        console.error("Error al cargar la publicación:", error);
        postElement.innerHTML = '<p class="error-message">Error al cargar la publicación</p>';
      });
    }

    // Escuchar comentarios
    function listenToComments(postId) {
      if (!postId) return;
      
      const order = orderSelect.value;
      
      if (unsubscribeComments) unsubscribeComments();

      unsubscribeComments = db.collection("posts").doc(postId)
        .collection("comments")
        .orderBy("createdAt", order)
        .onSnapshot(snapshot => {
          commentsElement.innerHTML = "";
          
          if (snapshot.empty) {
            commentsElement.innerHTML = '<p class="no-comments">No hay comentarios aún. ¡Sé el primero en comentar!</p>';
            return;
          }

          snapshot.forEach(doc => {
            const c = doc.data();
            const date = c.createdAt?.toDate().toLocaleString() || '';
            const div = document.createElement("div");
            div.className = "comment";
            
            div.innerHTML = `
              <div class="comment-header">
                <img src="${c.authorPhotoURL || '/placeholder.svg?height=40&width=40'}" alt="Foto de perfil" class="comment-author-photo">
                <div>
                  <strong class="comment-author-name">${c.authorName || 'Anónimo'}</strong><br>
                  <small class="comment-date">${date}</small>
                </div>
              </div>
              <div class="comment-body">${c.text}</div>
            `;
            
            commentsElement.appendChild(div);
          });
        }, error => {
          console.error("Error al cargar comentarios:", error);
          commentsElement.innerHTML = '<p class="error-message">Error al cargar los comentarios</p>';
        });
    }

    // Añadir comentario
    function addComment() {
      const name = commenterName.value.trim() || 'Anónimo';
      const text = commentText.value.trim();
      
      hideMessages();
      
      if (!text) {
        showErrorMessage("Debes escribir un comentario");
        return;
      }
      
      if (!postId) {
        showErrorMessage("Error: No se pudo identificar la publicación");
        return;
      }
      
      btnAddComment.disabled = true;
      btnAddComment.textContent = "Publicando...";
      
      db.collection("posts").doc(postId).collection("comments").add({
        text,
        authorName: name,
        createdAt: firebase.firestore.FieldValue.serverTimestamp()
      }).then(() => {
        commentText.value = "";
        showSuccessMessage("Comentario publicado correctamente");
        btnAddComment.disabled = false;
        btnAddComment.textContent = "Publicar comentario";
      }).catch(error => {
        console.error("Error al publicar comentario:", error);
        showErrorMessage("Error al publicar el comentario. Intenta de nuevo.");
        btnAddComment.disabled = false;
        btnAddComment.textContent = "Publicar comentario";
      });
    }

    // Funciones de utilidad para mensajes
    function hideMessages() {
      commentError.style.display = 'none';
      commentSuccess.style.display = 'none';
    }
    
    function showErrorMessage(message) {
      commentError.textContent = message;
      commentError.style.display = 'block';
    }
    
    function showSuccessMessage(message) {
      commentSuccess.textContent = message;
      commentSuccess.style.display = 'block';
    }

    // Event listeners
    orderSelect.addEventListener("change", () => {
      if (postId) listenToComments(postId);
    });
    
    btnAddComment.addEventListener("click", addComment);
    
    commentText.addEventListener("keypress", (e) => {
      if (e.key === "Enter" && e.ctrlKey) {
        addComment();
      }
    });

    // Inicialización
    document.addEventListener("DOMContentLoaded", () => {
      if (postId) {
        loadPost(postId);
        listenToComments(postId);
      } else {
        postElement.innerHTML = '<p class="error-message">No se especificó ninguna publicación</p>';
      }
    });
  </script>
</body>
</html>
